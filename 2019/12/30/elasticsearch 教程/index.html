<!DOCTYPE html>
<html lang="zh-Hansn">





<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/avatar.png">
  <link rel="icon" type="image/png" href="/img/avatar.png">
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="description" content="">
  <meta name="author" content="JiaoPan">
  <meta name="keywords" content="deep learning|computer vision">
  <title>elasticsearch 教程 ~ 今天的风儿甚是喧嚣 JiaoPan</title>

  <link rel="stylesheet" href="/lib/font-awesome/css/all.min.css"  >
<link rel="stylesheet" href="/lib/bootstrap/css/bootstrap.min.css"  >
<link rel="stylesheet" href="/lib/mdbootstrap/css/mdb.min.css"  >
<link rel="stylesheet" href="/lib/github-markdown/github-markdown.min.css"  >

<link rel="stylesheet" href="//at.alicdn.com/t/font_1067060_qzomjdt8bmp.css">



  <link rel="stylesheet" href="/lib/prettify/tomorrow-night-eighties.min.css"  >

<link rel="stylesheet" href="/css/main.css"  >


  <link rel="stylesheet" href="/lib/fancybox/jquery.fancybox.min.css"  >


<meta name="generator" content="Hexo 4.2.0"></head>


<body>
  <header style="height: 70vh;">
    <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand"
       href="/">&nbsp;<strong>今天的风儿甚是喧嚣 JiaoPan</strong>&nbsp;</a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
          <li class="nav-item">
            <a class="nav-link" href="/">主页</a>
          </li>
        
          
          
          
          
          <li class="nav-item">
            <a class="nav-link" href="/archives/">归档</a>
          </li>
        
          
          
          
          
          <li class="nav-item">
            <a class="nav-link" href="/categories/">分类</a>
          </li>
        
          
          
          
          
          <li class="nav-item">
            <a class="nav-link" href="/tags/">标签</a>
          </li>
        
          
          
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" data-toggle="modal" data-target="#modalSearch">&nbsp;&nbsp;<i
                class="iconfont icon-search"></i>&nbsp;&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

    <div class="view intro-2" id="background"
         style="background: url('/img/default.png')no-repeat center center;
           background-size: cover;
           background-attachment: fixed;">
      <div class="full-bg-img">
        <div class="mask rgba-black-light flex-center">
          <div class="container text-center white-text fadeInUp">
            <span class="h2" id="subtitle">
              
            </span>

            
              <br>
              
                <p class="mt-3">
                  <i class="fas fa-calendar-alt" aria-hidden="true"></i>&nbsp;
                  Monday, December 30th 2019, 3:40 pm
                </p>
              

              <p>
                
                  
                  &nbsp;<i class="far fa-chart-bar"></i>
                  <span class="post-count">
                    2.7k 字
                  </span>&nbsp;
                

                
                  
                  &nbsp;<i class="far fa-clock"></i>
                  <span class="post-count">
                      16 分钟
                  </span>&nbsp;
                

                
                  <!-- 不蒜子统计文章PV -->
                  
                  &nbsp;<i class="far fa-eye" aria-hidden="true"></i>&nbsp;
                  <span id="busuanzi_container_page_pv">
                    <span id="busuanzi_value_page_pv"></span> 次
                  </span>&nbsp;
                
              </p>
            
          </div>

          
        </div>
      </div>
    </div>
  </header>

  <main>
    
      

<div class="container-fluid">
  <div class="row">
    <div class="d-none d-lg-block col-lg-2"></div>
    <div class="col-lg-8 nopadding-md">
      <div class="py-5 z-depth-3" id="board">
        <div class="post-content mx-auto" id="post">
          <div class="markdown-body">
            <h1 id="elasticsearch-教程"><a href="#elasticsearch-教程" class="headerlink" title="elasticsearch 教程"></a>elasticsearch 教程</h1><p><img src="/images/elasticsearch/1.jpg" srcset="/img/loading.gif" alt=""></p>
<h2 id="安装、启动、测试"><a href="#安装、启动、测试" class="headerlink" title="安装、启动、测试"></a>安装、启动、测试</h2><p>elasticsearch下载地址:<a href="https://www.elastic.co/cn/downloads/elasticsearch" target="_blank" rel="noopener">https://www.elastic.co/cn/downloads/elasticsearch</a></p>
<p>kibana下载地址:<a href="https://www.elastic.co/cn/downloads/kibana" target="_blank" rel="noopener">https://www.elastic.co/cn/downloads/kibana</a></p>
<p><strong>启动</strong></p>
<pre><code class="lang-bash">./elasticsearch-7.5.1/bin/elasticsearch #浏览器访问：localhost:9200
</code></pre>
<pre><code class="lang-bash">{
  &quot;name&quot; : &quot;jiaopandeMacBook-Pro.local&quot;,
  &quot;cluster_name&quot; : &quot;elasticsearch&quot;,
  &quot;cluster_uuid&quot; : &quot;5vku_94_SjevMGVYIo3RYg&quot;,
  &quot;version&quot; : {
    &quot;number&quot; : &quot;7.5.1&quot;,
    &quot;build_flavor&quot; : &quot;default&quot;,
    &quot;build_type&quot; : &quot;tar&quot;,
    &quot;build_hash&quot; : &quot;3ae9ac9a93c95bd0cdc054951cf95d88e1e18d96&quot;,
    &quot;build_date&quot; : &quot;2019-12-16T22:57:37.835892Z&quot;,
    &quot;build_snapshot&quot; : false,
    &quot;lucene_version&quot; : &quot;8.3.0&quot;,
    &quot;minimum_wire_compatibility_version&quot; : &quot;6.8.0&quot;,
    &quot;minimum_index_compatibility_version&quot; : &quot;6.0.0-beta1&quot;
  },
  &quot;tagline&quot; : &quot;You Know, for Search&quot;
}
</code></pre>
<p>配置kibana-7.5.1-darwin-x86_64/config/kibana.yml</p>
<pre><code class="lang-bash">server.host: &quot;localhost&quot;
elasticsearch.hosts: [&quot;http://localhost:9200&quot;]
</code></pre>
<pre><code class="lang-bash">./kibana-7.5.1-darwin-x86_64/bin/kibana #浏览器访问：localhost:5601
</code></pre>
<p><img src="/images/elasticsearch/2.jpg" srcset="/img/loading.gif" alt=""></p>
<p><strong>测试</strong><br>kibana Dev Tools</p>
<p><img src="/images/elasticsearch/3.jpg" srcset="/img/loading.gif" alt=""></p>
<h2 id="index"><a href="#index" class="headerlink" title="index"></a>index</h2><p><strong>创建索引</strong></p>
<pre><code class="lang-bash">PUT http://127.0.0.1:9200/test_index
</code></pre>
<p><strong>删除索引</strong></p>
<pre><code class="lang-bash">DELETE http://127.0.0.1:9200/test_index
</code></pre>
<p><strong>索引别名</strong></p>
<pre><code class="lang-bash">POST _aliases
{
    &quot;actions&quot;: [
        { &quot;add&quot; : { &quot;index&quot; : &quot;test_index&quot;, &quot;alias&quot; : &quot;test&quot; } }
    ]
}
</code></pre>
<p><strong>索引迁移</strong></p>
<pre><code class="lang-bash">POST _reindex
{
    &quot;source&quot;: {
        &quot;index&quot;: &quot;test_index&quot;
    },
    &quot;dest&quot;: {
        &quot;index&quot;: &quot;test_index_v2&quot;
    }
}

POST _aliases
{
    &quot;actions&quot;: [
        { &quot;remove&quot; : { &quot;index&quot; : &quot;test_index&quot;, &quot;alias&quot; : &quot;test&quot; } },
        { &quot;add&quot; : { &quot;index&quot; : &quot;test_index_v2&quot;, &quot;alias&quot; : &quot;test_v2&quot; } }
    ]
}
</code></pre>
<p><strong>索引mapping设置</strong></p>
<pre><code class="lang-bash">PUT /dyw_index_v2
{
  &quot;settings&quot;: {
    &quot;analysis&quot;: {
      &quot;analyzer&quot;: {
        &quot;default&quot;: {
          &quot;type&quot;: &quot;ik_max_word&quot;
        }
      }
    }
  },
  &quot;mappings&quot;: {
    &quot;properties&quot;: {
      &quot;type&quot;:{
        &quot;type&quot;: &quot;keyword&quot;
      },
      &quot;tags&quot;:{
        &quot;type&quot;: &quot;text&quot; 
      },
      &quot;content&quot;:{
        &quot;type&quot;: &quot;text&quot;,
        &quot;boost&quot;: 2
      },
      &quot;suggest&quot; : {
        &quot;type&quot; : &quot;completion&quot;,
        &quot;analyzer&quot;: &quot;ik_max_word&quot;
      },
      &quot;update_time&quot;:{
            &quot;type&quot;: &quot;date&quot;,
            &quot;format&quot;: [&quot;yyyy-MM-dd HH:mm:ss&quot;]
      },
      &quot;location&quot;:{
            &quot;type&quot;: &quot;geo_point&quot;
      },
      &quot;join&quot;:{
        &quot;type&quot;: &quot;object&quot;,
        &quot;properties&quot;: {
          &quot;id&quot;:{
            &quot;type&quot;:&quot;keyword&quot;
          },
          &quot;content&quot;:{
            &quot;type&quot;:&quot;text&quot;
          }
        }
      },
      &quot;extra&quot;:{
        &quot;type&quot;: &quot;object&quot;,
        &quot;properties&quot;: {
          &quot;scene&quot;:{
            &quot;type&quot;: &quot;nested&quot;,
            &quot;properties&quot;: {
                &quot;id&quot;:{
                  &quot;type&quot;: &quot;keyword&quot;
                },
                &quot;position&quot;:{
                  &quot;type&quot;: &quot;integer&quot;
                }
             }
          }
        }
      }
    }
  }
}
</code></pre>
<h2 id="document"><a href="#document" class="headerlink" title="document"></a>document</h2><p><a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/index.html" target="_blank" rel="noopener">https://www.elastic.co/guide/en/elasticsearch/reference/current/index.html</a></p>
<h2 id="安装中文分词"><a href="#安装中文分词" class="headerlink" title="安装中文分词"></a>安装中文分词</h2><pre><code class="lang-bash">./bin/elasticsearch-plugin install https://github.com/medcl/elasticsearch-analysis-ik/releases/download/v7.5.1/elasticsearch-analysis-ik-7.5.1.zip
</code></pre>
<h2 id="Java-API"><a href="#Java-API" class="headerlink" title="Java API"></a>Java API</h2><p><strong>pom依赖</strong></p>
<pre><code class="lang-xml">&lt;dependency&gt;
    &lt;groupId&gt;org.elasticsearch.client&lt;/groupId&gt;
    &lt;artifactId&gt;elasticsearch-rest-high-level-client&lt;/artifactId&gt;
    &lt;version&gt;7.5.1&lt;/version&gt;
&lt;/dependency&gt;
&lt;dependency&gt;
    &lt;groupId&gt;org.elasticsearch.client&lt;/groupId&gt;
    &lt;artifactId&gt;elasticsearch-rest-client&lt;/artifactId&gt;
    &lt;version&gt;7.5.1&lt;/version&gt;
&lt;/dependency&gt;
&lt;dependency&gt;
    &lt;groupId&gt;org.elasticsearch&lt;/groupId&gt;
    &lt;artifactId&gt;elasticsearch&lt;/artifactId&gt;
    &lt;version&gt;7.5.1&lt;/version&gt;
&lt;/dependency&gt;
</code></pre>
<p><strong>客户端</strong></p>
<pre><code class="lang-java">/** 
* @author 作者 jiaopan: 
* @version 创建时间：Feb 10, 2020 11:09:05 AM 
* 类说明 
*/
public class ESClient {
    private volatile static RestHighLevelClient client;

    public static RestHighLevelClient instance(EsConfigValue config) {  
        if (client == null) {  
            synchronized (RestHighLevelClient.class) {  
                if (client == null) {  
                    final CredentialsProvider credentialsProvider = new BasicCredentialsProvider();
                    credentialsProvider.setCredentials(AuthScope.ANY, new UsernamePasswordCredentials(config.getUsername(),config.getPassword()));
                    client = new RestHighLevelClient(RestClient.builder(new HttpHost(config.getIp(),config.getPort(), &quot;http&quot;))
                             .setHttpClientConfigCallback(new RestClientBuilder.HttpClientConfigCallback() {
                                    @Override
                                    public HttpAsyncClientBuilder customizeHttpClient(HttpAsyncClientBuilder httpClientBuilder) {
                                        httpClientBuilder.disableAuthCaching();
                                        return httpClientBuilder.setDefaultCredentialsProvider(credentialsProvider);
                                    }
                    }));
                }  
            }  
        }  
        return client;  
    }      
    /*
    public static RestHighLevelClient instance(EsConfigValue config) {  
        if (client == null) {  
            synchronized (RestHighLevelClient.class) {  
                if (client == null) {  
                    client = new RestHighLevelClient(RestClient.builder(new HttpHost(config.getIp(),config.getPort(), &quot;http&quot;)));
                }  
            }  
        }  
        return client;  
    } 
    */
}
</code></pre>
<p><strong> base apis</strong></p>
<pre><code class="lang-java">public Boolean isExist(String index, String id,String routing) {
    RestHighLevelClient client = ESClient.instance(esConfig);
    GetRequest request = new GetRequest(index).id(id);
    request.fetchSourceContext(new FetchSourceContext(false));
    request.storedFields(&quot;_none_&quot;);
    request.routing(routing);
    try {
        return client.exists(request, RequestOptions.DEFAULT);
    } catch (IOException e) {
        return false;
    }
}

public Map&lt;String, Object&gt; get(String index, String id,String routing) throws IOException {
    RestHighLevelClient client = ESClient.instance(esConfig);
    GetRequest request = new GetRequest(esConfig.getIndex(), id);
    request.routing(routing);
    GetResponse getResponse = client.get(request, RequestOptions.DEFAULT);
    Map&lt;String, Object&gt; doc = new HashMap&lt;String, Object&gt;();
    if(getResponse.isExists()) {
        doc = getResponse.getSourceAsMap();
        doc.put(&quot;id&quot;,getResponse.getId());
    }
    return doc;
}

public SearchResponse getByIds(List&lt;String&gt; ids) throws IOException {
    RestHighLevelClient client = ESClient.instance(esConfig);
    SearchRequest searchRequest = new SearchRequest(esConfig.getIndex()); 
    SearchSourceBuilder searchSourceBuilder = new SearchSourceBuilder(); 

    BoolQueryBuilder booleanQueryBuilder = QueryBuilders.boolQuery();
    IdsQueryBuilder idsQueryBuilder = QueryBuilders.idsQuery();
    idsQueryBuilder.ids().addAll(ids);

    booleanQueryBuilder.must(idsQueryBuilder);
    /*构建查询*/
    searchSourceBuilder.from(0);
    searchSourceBuilder.size(ids.size());
    searchSourceBuilder.query(booleanQueryBuilder); 
    searchRequest.source(searchSourceBuilder);
    SearchResponse searchResponse = client.search(searchRequest, RequestOptions.DEFAULT);
    return searchResponse;
}

public void createOrUpdate(String index, String id,String routing,JSONObject item,Boolean bulk) throws IOException {

    RestHighLevelClient client = ESClient.instance(esConfig);
    GetRequest request = new GetRequest(esConfig.getIndex(), id);
    request.routing(routing);
    JSONObject doc = new JSONObject();
    GetResponse getResponse = client.get(request, RequestOptions.DEFAULT);
    if(getResponse.isExists()) {
        Map&lt;String, Object&gt; source = getResponse.getSourceAsMap();
        JSONObject content = JSONObject.parseObject(source.get(&quot;content&quot;).toString());
        item.keySet().forEach(key-&gt;{
            content.put(key,item.get(key));
        });
        doc = this.createDocSource(content,routing,true);
    }
    else
        doc = this.createDocSource(item,routing,false);
    if(bulk)
        this.bulkUpdate(index, id, doc, true, routing);
    else
        this.update(index, id, doc, true,routing);
}

public void delete(String index, String id,String routing) {
    RestHighLevelClient client = ESClient.instance(esConfig);
    DeleteRequest request = new DeleteRequest(index, id);
    request.routing(routing);
    client.deleteAsync(request, RequestOptions.DEFAULT, new ActionListener&lt;DeleteResponse&gt;() {
        @Override
        public void onResponse(DeleteResponse response) {
            if (response.getResult() == DocWriteResponse.Result.DELETED) {
                logger.info(&quot;delete&gt;&gt;&gt;&quot;+&quot;{\&quot;id\&quot;:\&quot;&quot;+id+&quot;\&quot;,\&quot;type\&quot;:\&quot;&quot;+routing+&quot;\&quot;}&quot;);
            }
        }
        @Override
        public void onFailure(Exception e) {
            logger.info(&quot;delete fail&gt;&gt;&gt;&quot;+&quot;{\&quot;id\&quot;:\&quot;&quot;+id+&quot;\&quot;,\&quot;type\&quot;:\&quot;&quot;+routing+&quot;\&quot;}&quot;);
        }
    });
}

public void update(String index, String id, JSONObject item,Boolean upsert,String routing) {
    if(item == null) {
        return;
    }
    RestHighLevelClient client = ESClient.instance(esConfig);
    UpdateRequest request = new UpdateRequest(index,id).doc(item); 
    request.docAsUpsert(upsert);
    request.retryOnConflict(3);
    request.routing(routing);
    client.updateAsync(request, RequestOptions.DEFAULT, new ActionListener&lt;UpdateResponse&gt;() {
        @Override
        public void onResponse(UpdateResponse response) {
            if (response.getResult() == DocWriteResponse.Result.CREATED) {
                logger.info(&quot;created&gt;&gt;&gt;&quot;+&quot;{\&quot;id\&quot;:\&quot;&quot;+id+&quot;\&quot;,\&quot;type\&quot;:\&quot;&quot;+routing+&quot;\&quot;}&quot;);
            }
            else if (response.getResult() == DocWriteResponse.Result.UPDATED) {
                logger.info(&quot;updated&gt;&gt;&gt;&quot;+&quot;{\&quot;id\&quot;:\&quot;&quot;+id+&quot;\&quot;,\&quot;type\&quot;:\&quot;&quot;+routing+&quot;\&quot;}&quot;);
            }
        }
        @Override
        public void onFailure(Exception e) {
            logger.warn(&quot;not_store_record(&quot;+e.getMessage()+&quot;)&gt;&gt;&gt;&quot;+item.toJSONString());
        }
    });
}

public void bulkUpdate(String index, String id, JSONObject item,Boolean upsert,String routing) {
    if(item == null) {
        return;
    }
    UpdateRequest request = new UpdateRequest(index,id).doc(item); 
    request.docAsUpsert(upsert);
    request.retryOnConflict(3);
    request.routing(routing);
    queue.offer(request);
}

public void bulk(ConcurrentLinkedQueue&lt;UpdateRequest&gt; queue, RestHighLevelClient client) {
    BulkRequest bulk = new BulkRequest();
    for (int i = 0; i &lt; esConfig.getBulk(); i++) {
        if(queue.isEmpty()) break;
        bulk.add(queue.poll());
    }
    if(bulk.numberOfActions() == 0) return;
    logger.info(DateUtils.getNowDate()+&quot;:starting handle doc queue,actions:&quot;+bulk.numberOfActions());
    client.bulkAsync(bulk, RequestOptions.DEFAULT, new ActionListener&lt;BulkResponse&gt;() {
        @Override
        public void onResponse(BulkResponse response) {
            if(response.hasFailures())
                logger.info(response.buildFailureMessage());
        }
        @Override
        public void onFailure(Exception e) {
            logger.warn(&quot;bulk handle docs error:&quot;+e.getMessage());
        }
    });
}
</code></pre>
<p><strong>Common apis</strong></p>
<pre><code class="lang-java">
public void locationSearch(SearchSourceBuilder searchSourceBuilder, BoolQueryBuilder booleanQueryBuilder,
        String location,String lockey,Double distance,Boolean sort) throws FontFormatException {
    String[] latlon = location.split(&quot;,&quot;);
    if(latlon.length != 2) {
        throw new NumberFormatException(&quot;经纬度参数不正确.location参数以英文逗号(,)连接的字符串.正确示例:“纬度(latitude),经度(longitude)\&quot;&quot;);
    }
    Double lat = Double.parseDouble(latlon[0]);
    Double lon = Double.parseDouble(latlon[1]);

    GeoDistanceQueryBuilder geoQueryBuilder = QueryBuilders.geoDistanceQuery(lockey).point(lat, lon)
                                   .distance(distance == null?esConfig.getDistance():distance, DistanceUnit.KILOMETERS)
                                   .geoDistance(GeoDistance.PLANE);
    if(sort) {
        GeoDistanceSortBuilder distanceSortBuilder = SortBuilders.geoDistanceSort(lockey,lat,lon);
        distanceSortBuilder.order(SortOrder.ASC);
        distanceSortBuilder.point(lat, lon);
        searchSourceBuilder.sort(distanceSortBuilder);
    }
    booleanQueryBuilder.must(geoQueryBuilder);
}

public void fullTextSearch(BoolQueryBuilder booleanQueryBuilder, String keyword,List&lt;String&gt; fields,Boolean must) {
    DisMaxQueryBuilder disMaxQueryBuilder = QueryBuilders.disMaxQuery();
    fields.forEach(item-&gt;{
        disMaxQueryBuilder.add(QueryBuilders.matchQuery(item,keyword));
    });
    if(must) booleanQueryBuilder.must(disMaxQueryBuilder);
    else booleanQueryBuilder.should(disMaxQueryBuilder);
}

public void phraseTextSearch(BoolQueryBuilder booleanQueryBuilder, String keyword,List&lt;String&gt; fields,Boolean must) {
    DisMaxQueryBuilder disMaxQueryBuilder = QueryBuilders.disMaxQuery();
    List&lt;String&gt; words = Arrays.asList(keyword.split(&quot; &quot;));
    fields.forEach(item-&gt;{
        words.forEach(word-&gt;{
            disMaxQueryBuilder.add(QueryBuilders.matchPhraseQuery(item,word));
        });
    });
    if(must) booleanQueryBuilder.must(disMaxQueryBuilder);
    else booleanQueryBuilder.should(disMaxQueryBuilder);
}

public void textSearch(BoolQueryBuilder booleanQueryBuilder, String keyword, List&lt;String&gt; fields, Boolean phrase,Boolean must) {
    if(phrase) phraseTextSearch(booleanQueryBuilder, keyword, fields,must);
    else fullTextSearch(booleanQueryBuilder, keyword, fields,must);
}

public void typeSearch(BoolQueryBuilder booleanQueryBuilder,String key,List&lt;String&gt; typeArray, List&lt;String&gt; mustNot) {
    DisMaxQueryBuilder disMaxQueryBuilder = QueryBuilders.disMaxQuery();
    for (int i = 0; i &lt; typeArray.size(); i++) {
        disMaxQueryBuilder.add(QueryBuilders.termQuery(key,typeArray.get(i)));
    }
    booleanQueryBuilder.must(disMaxQueryBuilder);

    List&lt;QueryBuilder&gt; mustNotQuerys = new ArrayList&lt;QueryBuilder&gt;();
    for (int i = 0; i &lt; mustNot.size(); i++) {
        QueryBuilder query = QueryBuilders.termQuery(key,mustNot.get(i));
        mustNotQuerys.add(query);
    }
    booleanQueryBuilder.mustNot().addAll(mustNotQuerys);
}

public void typeSearch(BoolQueryBuilder booleanQueryBuilder,String key, List&lt;String&gt; typeArray) {
    DisMaxQueryBuilder disMaxQueryBuilder = QueryBuilders.disMaxQuery();
    for (int i = 0; i &lt; typeArray.size(); i++) {
        disMaxQueryBuilder.add(QueryBuilders.termQuery(key,typeArray.get(i)));
    }
    booleanQueryBuilder.must(disMaxQueryBuilder);
}

public void createQuery(SearchRequest searchRequest, SearchSourceBuilder searchSourceBuilder,Integer from, Integer size, QueryBuilder queryBuilder) {
    searchSourceBuilder.from(from == null?esConfig.getFrom():from);
    searchSourceBuilder.size(size == null?esConfig.getSize():size);
    searchSourceBuilder.query(queryBuilder); 
    searchRequest.source(searchSourceBuilder);
}

public void createQuery(SearchRequest searchRequest, SearchSourceBuilder searchSourceBuilder,Integer from, Integer size, QueryBuilder queryBuilder, QueryBuilder postFilter) {
    searchSourceBuilder.from(from == null?esConfig.getFrom():from);
    searchSourceBuilder.size(size == null?esConfig.getSize():size);
    searchSourceBuilder.query(queryBuilder); 
    searchSourceBuilder.postFilter(postFilter);
    searchRequest.source(searchSourceBuilder);
}

public void sort(SearchSourceBuilder searchSourceBuilder, int sortField) {
    String field = dict.getSortField().get(sortField);
    String order = dict.getSortType().get(field);
    searchSourceBuilder.sort(new FieldSortBuilder(field).order(SortOrder.fromString(order)));
}

public void searchMustNot(BoolQueryBuilder booleanQueryBuilder,String field,String values) {
    List&lt;String&gt; mustNot = Arrays.asList(values.split(&quot;,&quot;));
    mustNot.forEach(item-&gt;{
booleanQueryBuilder.mustNot(QueryBuilders.termQuery(field,item));
    });
}
</code></pre>
<p><strong>search</strong></p>
<pre><code class="lang-java">public List&lt;Map&lt;String, Object&gt;&gt; search(String keyword,String scopes, Integer from, Integer size,String location, Double distance,Boolean matchPhrase,Boolean scoreSort) throws IOException, FontFormatException {

    RestHighLevelClient client = ESClient.instance(esConfig);
    SearchRequest searchRequest = new SearchRequest(esConfig.getIndex()); 
    SearchSourceBuilder searchSourceBuilder = new SearchSourceBuilder(); 

    BoolQueryBuilder booleanQueryBuilder = QueryBuilders.boolQuery();

    /*type检索*/
    if(!StringUtils.equals(scopes,&quot;all&quot;)) {
        List&lt;String&gt; scopeArray = new ArrayList&lt;String&gt;(); 
        scopeArray = Arrays.asList(scopes.split(&quot;,&quot;)); 
        engineBaseMethod.typeSearch(booleanQueryBuilder,&quot;type&quot;,scopeArray);
    }

    String notTypes = StringUtils.join(dict.getMustNot(), &quot;,&quot;);
    engineBaseMethod.searchMustNot(booleanQueryBuilder, &quot;type&quot;,notTypes);
    booleanQueryBuilder.must(QueryBuilders.termQuery(&quot;extra.up&quot;,&quot;1&quot;));

    /*多字段检索*/
    if(StringUtils.isNotBlank(keyword)) {
        //List&lt;String&gt; fieldList = Arrays.asList(&quot;title,cn_name,suggest&quot;.split(&quot;,&quot;)); 
        List&lt;String&gt; fieldList = dict.getSearchMatch();
        engineBaseMethod.textSearch(booleanQueryBuilder, keyword, fieldList, matchPhrase,true);
    }
    /*排序*/
    engineBaseMethod.sort(searchSourceBuilder,0);
    engineBaseMethod.sort(searchSourceBuilder,1);

    /*地理位置范围内搜索并就近排序*/
    if(StringUtils.isNotBlank(location)) {
        engineBaseMethod.locationSearch(searchSourceBuilder, booleanQueryBuilder, location,&quot;location&quot;,distance,true);
    }

    int index = 2 + (int)(Math.random() * ((3 - 2) + 1));
    if(scoreSort) searchSourceBuilder.sort(new ScoreSortBuilder().order(SortOrder.DESC));
    else engineBaseMethod.sort(searchSourceBuilder,index);


    /*构建查询*/
    engineBaseMethod.createQuery(searchRequest, searchSourceBuilder, from, size, booleanQueryBuilder);
    SearchResponse searchResponse = client.search(searchRequest, RequestOptions.DEFAULT);
    /*解析结果并返回*/
    List&lt;Map&lt;String, Object&gt;&gt; result = new ArrayList&lt;Map&lt;String,Object&gt;&gt;();
    engineBaseMethod.searchResultAnalyse(result, searchResponse);
    return result;
}

public List&lt;String&gt; searchTips(String keyword, String type) throws IOException, FontFormatException {
    RestHighLevelClient client = ESClient.instance(esConfig);

    //前缀搜索建议
    SearchRequest searchRequest = new SearchRequest(esConfig.getIndex()); 
    SearchSourceBuilder searchSourceBuilder = new SearchSourceBuilder(); 
    CompletionSuggestionBuilder suggestionBuilder = new CompletionSuggestionBuilder(&quot;suggest&quot;);
    suggestionBuilder.prefix(keyword);
    suggestionBuilder.size(esConfig.getSize());
    suggestionBuilder.skipDuplicates(true);
    SuggestBuilder suggestBuilder = new SuggestBuilder();
    suggestBuilder.addSuggestion(&quot;search_tips&quot;, suggestionBuilder);
    searchSourceBuilder.suggest(suggestBuilder);
    searchRequest.source(searchSourceBuilder);
    SearchResponse searchResponse = client.search(searchRequest, RequestOptions.DEFAULT);

    //匹配搜索建议
    SearchSourceBuilder querySourceBuilder = new SearchSourceBuilder(); 
    SearchRequest queryRequest = new SearchRequest(esConfig.getIndex()); 
    BoolQueryBuilder booleanQueryBuilder = QueryBuilders.boolQuery();
    if(StringUtils.isNotBlank(keyword)) booleanQueryBuilder.should(QueryBuilders.matchQuery(&quot;title&quot;,keyword));
    String notTypes = StringUtils.join(dict.getMustNot(), &quot;,&quot;);
    engineBaseMethod.searchMustNot(booleanQueryBuilder, &quot;type&quot;,notTypes);
    querySourceBuilder.query(booleanQueryBuilder);
    queryRequest.source(querySourceBuilder);
    SearchResponse queryResponse = client.search(queryRequest, RequestOptions.DEFAULT);

    /*解析结果并返回*/
    List&lt;String&gt; result = new ArrayList&lt;String&gt;();
    Suggest suggest = searchResponse.getSuggest();
    CompletionSuggestion completionSuggestion = suggest.getSuggestion(&quot;search_tips&quot;);
    for(CompletionSuggestion.Entry entry : completionSuggestion.getEntries()) { 
        for (CompletionSuggestion.Entry.Option option : entry) { 
            String optionType = option.getHit().getSourceAsMap().get(&quot;type&quot;).toString();
            if(StringUtils.equals(type, &quot;all&quot;) || StringUtils.equals(type,optionType)) result.add(option.getText().string());
        }
    }
    for(SearchHit hit:queryResponse.getHits()) {
        String text = (String) hit.getSourceAsMap().get(&quot;title&quot;);
        if(!result.contains(text)) result.add(text);
    }
    return result;
}
</code></pre>
<h2 id="集群安装"><a href="#集群安装" class="headerlink" title="集群安装"></a>集群安装</h2><p><strong>master 配置</strong></p>
<pre><code class="lang-bash"># ---------------------------------- Cluster -----------------------------------
cluster.name: es-cluster

# ------------------------------------ Node ------------------------------------
node.name: node1-rec
node.master: true
node.data: false 

# ----------------------------------- Paths ------------------------------------
path.data: /data/es/data
path.logs: /data/es/logs

# ----------------------------------- Memory -----------------------------------
bootstrap.memory_lock: false

# ---------------------------------- Network -----------------------------------
network.host: 0.0.0.0
network.publish_host: 10.2.64.110
http.port: 9200

# --------------------------------- Discovery ----------------------------------

discovery.seed_hosts: [&quot;10.2.64.110&quot;, &quot;10.2.64.111&quot;, &quot;10.2.64.112&quot;]

cluster.initial_master_nodes: [&quot;10.2.64.110&quot;]
discovery.zen.fd.ping_timeout: 1m
discovery.zen.fd.ping_retries: 5
http.cors.allow-origin: &quot;*&quot; 
http.cors.enabled: true
bootstrap.system_call_filter: false

xpack.license.self_generated.type: basic
</code></pre>
<p><strong>node 配置</strong></p>
<pre><code class="lang-bash">cluster.name: es-cluster
# ------------------------------------ Node ------------------------------------
node.name: node2-rec
node.master: false
node.data: true 
# ----------------------------------- Paths ------------------------------------
path.data: /data/es/data
path.logs: /data/es/logs
# ----------------------------------- Memory -----------------------------------
bootstrap.memory_lock: false
# ---------------------------------- Network -----------------------------------
network.host: 0.0.0.0
network.publish_host: 10.2.64.111
http.port: 9200
# --------------------------------- Discovery ----------------------------------
discovery.seed_hosts: [&quot;10.2.64.110&quot;, &quot;10.2.64.111&quot;, &quot;10.2.64.112&quot;]

cluster.initial_master_nodes: [&quot;10.2.64.110&quot;]
discovery.zen.fd.ping_timeout: 1m
discovery.zen.fd.ping_retries: 5
http.cors.allow-origin: &quot;*&quot; 
http.cors.enabled: true
bootstrap.system_call_filter: false
#
xpack.license.self_generated.type: basic
</code></pre>
<p><strong>master kibana 配置</strong></p>
<pre><code class="lang-bash">server.port: 5601
server.host: &quot;0.0.0.0&quot;
server.name: &quot;node1-rec&quot;
elasticsearch.hosts: [&quot;http://10.2.64.110:9200&quot;,&quot;http://10.2.64.111:9200&quot;,&quot;http://10.2.64.112:9200&quot;]
</code></pre>
<p><strong>Kibana查看集群状态</strong></p>
<pre><code>GET _cluster/health?pretty

{
  &quot;cluster_name&quot; : &quot;es-cluster&quot;,
  &quot;status&quot; : &quot;green&quot;,
  &quot;timed_out&quot; : false,
  &quot;number_of_nodes&quot; : 3,
  &quot;number_of_data_nodes&quot; : 2,
  &quot;active_primary_shards&quot; : 7,
  &quot;active_shards&quot; : 14,
  &quot;relocating_shards&quot; : 0,
  &quot;initializing_shards&quot; : 0,
  &quot;unassigned_shards&quot; : 0,
  &quot;delayed_unassigned_shards&quot; : 0,
  &quot;number_of_pending_tasks&quot; : 0,
  &quot;number_of_in_flight_fetch&quot; : 0,
  &quot;task_max_waiting_in_queue_millis&quot; : 0,
  &quot;active_shards_percent_as_number&quot; : 100.0
}
</code></pre>
            <hr>
          </div>
          <br>
          <div>
            <p>
            
              <span>
                <i class="iconfont icon-inbox"></i>
                
                  <a class="hover-with-bg" href="/categories/%E7%AC%94%E8%AE%B0">笔记</a>
                  &nbsp;
                
              </span>&nbsp;&nbsp;
            
            
              <span>
                <i class="iconfont icon-tag"></i>
                
                  <a class="hover-with-bg" href="/tags/elasticsearch">elasticsearch</a>
                
              </span>
            
            </p>
            
              <p class="note note-warning">本博客所有文章除特别声明外，均采用 <a href="https://zh.wikipedia.org/wiki/Wikipedia:CC_BY-SA_3.0%E5%8D%8F%E8%AE%AE%E6%96%87%E6%9C%AC" target="_blank" rel="nofollow noopener noopener">CC BY-SA 3.0协议</a> 。转载请注明出处！</p>
            
          </div>
        </div>
      </div>
    </div>
    <div class="d-none d-lg-block col-lg-2 toc-container">
      
  <div id="toc">
    <p class="h4"><i class="far fa-list-alt"></i>&nbsp;目录</p>
    <div id="tocbot"></div>
  </div>

    </div>
  </div>
</div>

<!-- custom -->


<!-- Comments -->
<div class="col-lg-7 mx-auto nopadding-md">
  <div class="container comments mx-auto" id="comments">
    
      <br><br>
      
      
  <script defer src="https://utteranc.es/client.js"
          repo="JiaoPaner/blog-talk"
          issue-term="pathname"
  
          label="utterances"
    
          theme="github-light"
          crossorigin="anonymous"
          async>
  </script>


    
  </div>
</div>

    
  </main>

  
    <a class="z-depth-1" id="scroll-top-button" href="#" role="button">
      <i class="fa fa-chevron-up scroll-top-arrow" aria-hidden="true"></i>
    </a>
  

  
    <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v"
                 for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>
  

  <footer class="mt-5">
  <div class="text-center py-3">
    <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><b>Hexo</b></a>
    <i class="iconfont icon-love"></i>
    <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"> <b>Fluid</b></a>
    <br>

    
  
    <!-- 不蒜子统计PV -->
    
    &nbsp;<span id="busuanzi_container_site_pv">总访问量 
          <span id="busuanzi_value_site_pv"></span> 次</span>&nbsp;
  
  
    <!-- 不蒜子统计UV -->
    
    &nbsp;<span id="busuanzi_container_site_uv">总访客数 
            <span id="busuanzi_value_site_uv"></span> 人</span>&nbsp;
  
  <br>



    


    <!-- cnzz Analytics icon -->
    

  </div>
</footer>

<!-- SCRIPTS -->
<script src="/lib/jquery/jquery.min.js" ></script>
<script src="/lib/popper/popper.min.js" ></script>
<script src="/lib/bootstrap/js/bootstrap.min.js" ></script>
<script src="/lib/mdbootstrap/js/mdb.min.js" ></script>
<script src="/js/main.js" ></script>


  <script src="/js/lazyload.js" ></script>



  
    <script src="/lib/tocbot/tocbot.min.js" ></script>
  
  <script src="/js/post.js" ></script>



  <script src="/lib/smooth-scroll/smooth-scroll.min.js" ></script>



  <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" ></script>


<!-- Plugins -->


  

  

  

  

  <!-- cnzz Analytics -->
  



  <script src="/lib/prettify/prettify.min.js" ></script>
  <script>
    $(document).ready(function () {
      $('pre').addClass('prettyprint  linenums');
      prettyPrint();
    })
  </script>



  <script src="/lib/typed/typed.min.js" ></script>
  <script>
    var typed = new Typed('#subtitle', {
      strings: [
        '  ',
        "elasticsearch 教程&nbsp;",
      ],
      cursorChar: ".",
      typeSpeed: 70,
      loop: false,
    });
    typed.stop();
    $(document).ready(function () {
      $(".typed-cursor").addClass("h2");
      typed.start();
    });
  </script>



  <script src="/lib/anchor/anchor.min.js" ></script>
  <script>
    anchors.options = {
      placement: "right",
      visible: "false",
      
    };
    var el = "h1,h2,h3,h4,h5,h6".split(",");
    var res = [];
    for (item of el) {
      res.push(".markdown-body > " + item)
    }
    anchors.add(res.join(", "))
  </script>



  <script src="/js/local-search.js" ></script>
  <script>
    var path = "/local-search.xml";
    var inputArea = document.querySelector("#local-search-input");
    inputArea.onclick = function () {
      getSearchFile(path);
      this.onclick = null
    }
  </script>



  <script src="/lib/fancybox/jquery.fancybox.min.js" ></script>
  <script>
    $("#post img:not(.no-zoom img, img[no-zoom])").each(
      function () {
        var element = document.createElement("a");
        $(element).attr("data-fancybox", "images");
        $(element).attr("href", $(this).attr("src"));
        $(this).wrap(element);
      }
    );
  </script>



  

  
    <!-- MathJax -->
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
          tex2jax: {
              inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
              processEscapes: true,
              skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
          }
      });

      MathJax.Hub.Queue(function() {
          var all = MathJax.Hub.getAllJax(), i;
          for(i=0; i < all.length; i += 1) {
              all[i].SourceElement().parentNode.className += ' has-jax';
          }
      });

    </script>

    <script src="https://cdn.staticfile.org/mathjax/2.7.6/MathJax.js?config=TeX-MML-AM_CHTML" ></script>

  









</body>
</html>
